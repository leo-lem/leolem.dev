---
import { BaseLayout } from "../../layout";
import {
  formatDate,
  thumbnail,
  relatedArticlesByTags,
  relatedProjectsFor
} from "../../lib";
import { getBlog, getPortfolio } from "../../content";
import {
  FeaturedProject,
  ArticleRow,
  SubscribePanel,
  TopicPills,
  Thumbnail
} from "../../components";

export async function getStaticPaths() {
  return (await getBlog()).map((article) => ({
    params: { article: article.slug },
    props: article
  }));
}

const {
  data: { title, short, author, date, tags },
  slug,
  rendered
} = Astro.props;

const relatedProjects = relatedProjectsFor(await getPortfolio(), slug, 3);
const relatedArticles = relatedArticlesByTags(await getBlog(), slug, tags, 3);
const image = await thumbnail(`blog/${slug}`);
---

<BaseLayout
  title={title}
  description={short}
  thumbnail={image.src}
  ldJson={{
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    headline: title,
    description: short,
    author: author,
    datePublished: date.toISOString(),
    image: image.src,
    tags: tags?.join(", "),
    url: Astro.url,
    inLanguage: "en"
  }}
>
  <div slot="thumbnail" class="relative">
    <Thumbnail
      src={`blog/${slug}`}
      alt={`Thumbnail image for ${title}`}
      class="card-elevated"
      loading="eager"
    />

    <div class="absolute top-2 left-2 pill-overlay meta">
      {formatDate(date)}
    </div>

    {
      author?.name && (
        <div class="absolute top-2 right-2 pill-overlay meta">
          {author.url ? (
            <a
              href={author.url}
              class="link-muted"
              rel="noopener noreferrer"
              target="_blank"
            >
              {author.name}
            </a>
          ) : (
            author.name
          )}
        </div>
      )
    }

    <TopicPills
      topics={tags}
      class="absolute bottom-2 left-2 justify-center text-xs sm:text-sm"
    />
  </div>

  <article
    class="card p-4 prose prose-lg dark:prose-invert text-center sm:text-justify"
    set:html={rendered?.html}
  />

  <div class="container stack-sm text-center line-clamp-0">
    <div class="whitespace-nowrap text-xs sm:text-base">
      If you're still here, might as well subscribe :)
    </div>
    <SubscribePanel class="container-narrow stack-sm justify-center p-2" />
  </div>
  {
    relatedProjects.length > 0 && (
      <section class="container-narrow stack">
        <h2 class="title">Projects Featured In This Article</h2>

        <div class="split">
          {relatedProjects.map((project) => (
            <FeaturedProject project={project} />
          ))}
        </div>
      </section>
    )
  }

  {
    relatedArticles.length > 0 && (
      <section class="container-wide stack">
        <h2 class="title">Related Articles</h2>

        <div class="flex flex-col gap-2">
          {relatedArticles.map((article) => (
            <ArticleRow article={article} />
          ))}
        </div>
      </section>
    )
  }
</BaseLayout>
