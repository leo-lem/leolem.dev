---
import { getCollection } from "astro:content";

import BlogLayout from "../../layout/BlogLayout.astro";
import Tags from "../../components/Tags.astro";
import DynamicImage from "../../components/DynamicImage.astro";
import SubscribePanel from "../../components/SubscribePanel.astro";

const draftSlugs = import.meta.env.DRAFT_ARTICLES?.split(",") ?? [];
const featuredSlug = import.meta.env.FEATURED_ARTICLE;

const allArticles = (await getCollection("blog"))
  .filter(({ slug }) => !draftSlugs.includes(slug))
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const featuredIndex = featuredSlug
  ? allArticles.findIndex((a) => a.slug === featuredSlug)
  : -1;

const featured = featuredIndex >= 0 ? allArticles[featuredIndex] : undefined;

const articles =
  featuredIndex >= 0
    ? allArticles.filter((_, i) => i !== featuredIndex)
    : allArticles;
---

<BlogLayout
  title="My Blog"
  description="Welcome to my blog. I write about building software, exploring systems, and learning in public. Expect posts on Swift, CI/CD, architecture, side projects, and personal reflections from whatever I'm working through."
>
  <section class="flex flex-col gap-10">
    {
      featured && (
        <article class="border border-[var(--border-color)] rounded-2xl p-6 sm:p-8">
          <div class="flex flex-col sm:flex-row gap-6 items-center sm:items-start">
            <a href={`/blog/${featured.slug}/`} class="shrink-0">
              <DynamicImage
                src={`blog/${featured.slug}`}
                alt=""
                class="w-full sm:w-56 rounded-xl"
                loading="eager"
              />
            </a>

            <div class="w-full text-center sm:text-left">
              <p class="text-xs uppercase tracking-wide text-muted mb-2">
                Featured
              </p>

              <h2 class="text-primary text-2xl font-semibold mb-2">
                <a href={`/blog/${featured.slug}/`} class="hover:underline">
                  {featured.data.title}
                </a>
              </h2>

              <span class="text-sm text-muted text-nowrap">
                by {featured.data.author} |{" "}
                {featured.data.date.toLocaleDateString()}
              </span>

              <p class="text-secondary mt-3">{featured.data.short}.</p>

              <div class="flex flex-col mt-3 items-center sm:items-start">
                <Tags tags={featured.data.tags} />
              </div>
            </div>
          </div>
        </article>
      )
    }

    <SubscribePanel class="max-w-3xl mx-auto" />

    <ul class="flex flex-col">
      {
        articles.map(
          ({ slug, data: { title, author, date, short, tags } }, idx) => (
            <li class="w-full py-6">
              <div class="flex flex-col sm:flex-row gap-5 items-center sm:items-start">
                <a href={`/blog/${slug}/`} class="shrink-0">
                  <DynamicImage
                    src={`blog/${slug}`}
                    alt=""
                    class="w-full sm:w-36 rounded-xl"
                    loading={idx < 3 ? "eager" : "lazy"}
                  />
                </a>

                <div class="w-full text-center sm:text-left">
                  <h3 class="text-primary text-xl font-semibold mb-1">
                    <a href={`/blog/${slug}/`} class="hover:underline">
                      {title}
                    </a>
                  </h3>

                  <span class="text-sm text-muted text-nowrap">
                    by {author} | {date.toLocaleDateString()}
                  </span>

                  <p class="text-secondary mt-2">{short}.</p>

                  <div class="flex flex-col mt-3 items-center sm:items-start">
                    <Tags tags={tags} />
                  </div>
                </div>
              </div>

              <div class="border-[var(--border-color)] border w-full my-6 mx-auto" />
            </li>
          )
        )
      }
    </ul>
  </section>
</BlogLayout>
