---
import { getCollection } from "astro:content";

import BlogLayout from "../../layout/BlogLayout.astro";
import Tags from "../../components/Tags.astro";
import DynamicImage from "../../components/DynamicImage.astro";
import SubscribePanel from "../../components/SubscribePanel.astro";

const allArticles = (await getCollection("blog"))
  .filter(({ data: { date } }) => date <= new Date())
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());
const featured = allArticles.find(({ data: { featured } }) => featured);
const articles = allArticles.filter((article) => article !== featured);
---

<BlogLayout
  title="My Blog"
  description="Welcome to my blog. I write about building software, exploring systems, and learning in public. Expect posts on Swift, CI/CD, architecture, side projects, and personal reflections from whatever I'm working through."
>
  <section class="flex flex-col gap-10">
    {
      featured && (
        <div class="flex flex-col text-center border border-[var(--border-color)] rounded-2xl p-6 sm:p-8">
          <a href={`/blog/${featured.slug}/`} class="shrink-0 mb-4">
            <DynamicImage
              src={`blog/${featured.slug}`}
              alt="Featured article thumbnail"
              class="w-full rounded-xl"
              loading="eager"
            />
          </a>

          <h2 class="text-primary text-2xl font-semibold mb-2">
            <a href={`/blog/${featured.slug}/`} class="hover:underline">
              {featured.data.title}
            </a>
          </h2>

          <span class="text-sm text-muted text-nowrap">
            by {featured.data.author} |{" "}
            {featured.data.date.toLocaleDateString(undefined, {
              day: "numeric",
              month: "long",
              year: "numeric"
            })}
          </span>

          <p class="text-secondary mt-3">{featured.data.short}.</p>

          <div class="flex flex-col mt-3 items-center">
            <Tags tags={featured.data.tags} />
          </div>
        </div>
      )
    }

    <SubscribePanel class="max-w-3xl mx-auto" />

    <ul class="flex flex-col">
      {
        articles.map(
          ({ slug, data: { title, author, date, short, tags } }, idx) => (
            <li class="w-full py-6">
              <div class="flex flex-col sm:flex-row gap-5 items-center sm:items-start">
                <a href={`/blog/${slug}/`} class="shrink-0">
                  <DynamicImage
                    src={`blog/${slug}`}
                    alt=""
                    class="w-full sm:w-36 rounded-xl"
                    loading={idx < 3 ? "eager" : "lazy"}
                  />
                </a>

                <div class="w-full text-center sm:text-left">
                  <h3 class="text-primary text-xl font-semibold mb-1">
                    <a
                      href={`/blog/${slug}/`}
                      class="hover:underline line-clamp-1"
                    >
                      {title}
                    </a>
                  </h3>

                  <span class="text-sm text-muted text-nowrap">
                    by {author} |{" "}
                    {date.toLocaleDateString(undefined, {
                      day: "numeric",
                      month: "long",
                      year: "numeric"
                    })}
                  </span>

                  <p class="text-secondary mt-2">{short}.</p>
                </div>
              </div>

              <div class="border-[var(--border-color)] border w-full my-6 mx-auto" />
            </li>
          )
        )
      }
    </ul>
  </section>
</BlogLayout>
