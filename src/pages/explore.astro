---
import { BaseLayout } from "../layout";
import { categoriesFromTopics } from "../lib";
import { getTopics, getBlog, getPortfolio, getOffering } from "../content";
import { Thumbnail, TopicCard, TopicPills } from "../components";

const skills = await getTopics();
const categories = categoriesFromTopics(skills);

const results = [
  ...(await getBlog()).map((item) => ({
    ...item,
    type: "article",
    url: `/blog/${item.slug}/`
  })),
  ...(await getPortfolio()).map((item) => ({
    ...item,
    type: "project",
    url: `/portfolio/${item.slug}/`
  })),
  ...(await getOffering()).map((item) => ({
    ...item,
    type: "service",
    url: `/offering/#${item.slug}`
  }))
];
---

<BaseLayout
  title="Explore"
  description="Discover projects, articles, and services by exploring different technologies and topics. Filter by your interests to find relevant content."
>
  <section id="skills" class="container stack">
    {
      categories.map((category) => (
        <div class="stack sm:flex-row items-center">
          <h2 class="sm:[writing-mode:sideways-lr] text-2xl font-bold">
            {category}
          </h2>

          <div class="cluster">
            {skills
              .filter((skill) => skill.data.category === category)
              .map((topic) => (
                <TopicCard topic={topic} class="responsive w-36 pill" />
              ))}
          </div>
        </div>
      ))
    }
  </section>

  <section id="results" class="container-wide split">
    {
      results.map(async ({ slug, data: { title, short, tags }, type, url }) => (
        <div
          class="relative responsive card-elevated"
          data-tags={tags.join(",")}
        >
          <a href={url}>
            <span class="absolute top-2 left-2 meta pill-overlay capitalize ">
              «{type}»
            </span>

            {type === "project" || type === "article" ? (
              <Thumbnail
                src={`${type === "project" ? "portfolio" : "blog"}/${slug}`}
                alt={`Thumbnail for ${title}`}
                loading="eager"
              />
            ) : (
              <div class="thumbnail h-10" />
            )}

            <div class="stack text-center p-2">
              <h2 class="title-sm">{title}</h2>
              <p class="summary">{short}</p>
              <TopicPills
                topics={tags}
                class="items-center justify-center text-xs sm:text-sm"
              />
            </div>
          </a>
        </div>
      ))
    }

    <div id="no-results-placeholder" class="col-span-2 text-muted hidden">
      No results found. Try selecting different skills or clear all filters.
    </div>
  </section>
</BaseLayout>

<script is:inline>
  document.addEventListener("DOMContentLoaded", () => {
    const raw = window.location.search.match(/topics=([^#&]+)/)?.[1];
    const selectedTopics = raw ? decodeURIComponent(raw).split(",") : [];

    const cards = document.querySelectorAll("#results > div[data-tags]");
    let anyVisible = false;

    if (selectedTopics.length > 0) {
      cards.forEach((el) => {
        const tags = (el.dataset.tags ?? "").split(",");
        const match = selectedTopics.some((topic) => tags.includes(topic));
        el.style.display = match ? "" : "none";
        if (match) anyVisible = true;
      });
    } else {
      cards.forEach((el) => (el.style.display = ""));
      anyVisible = true;
    }

    const placeholder = document.getElementById("no-results-placeholder");
    if (placeholder) {
      placeholder.classList.toggle("hidden", anyVisible);
    }
  });
</script>
