---
import BaseLayout from "../layout/BaseLayout.astro";
import Tags from "../components/Tags.astro";

import { getCollection, type CollectionEntry } from "astro:content";
import TopicToggle from "../components/TopicToggle.astro";

const skills = (await getCollection("topics"))
  .sort((a, b) => (b.data.confidence ?? 0) - (a.data.confidence ?? 0))
  .sort((a, b) => (b.data.isPriority ? 1 : 0) - (a.data.isPriority ? 1 : 0));

const categories = skills
  .map((skill) => skill.data.category)
  .filter((value, index, self) => self.indexOf(value) === index);

const portfolio = await getCollection("portfolio");
const services = await getCollection("services");
const articles = (await getCollection("articles")).filter(
  ({ id }) => !(import.meta.env.DRAFT_ARTICLES?.split(",") ?? []).includes(id)
);

const results = [
  ...portfolio.map((item) => ({
    ...item,
    type: "project",
    url: `/portfolio/${item.slug}`
  })),
  ...articles.map((item) => ({
    ...item,
    type: "article",
    url: `/blog/${item.slug}`
  })),
  ...services.map((item) => ({
    ...item,
    type: "service",
    url: `/services#${item.slug}`
  }))
];
---

<BaseLayout
  title="Explore"
  description="Discover projects, articles, and services by exploring different technologies and topics. Filter by your interests to find relevant content."
>
  <section id="skills" class="flex flex-col gap-4">
    {
      categories.map((category) => (
        <div class="flex gap-4 items-center">
          <h2 class="[writing-mode:sideways-lr] text-xl">{category}</h2>

          <div class="flex flex-wrap gap-2">
            {skills
              .filter((skill) => skill.data.category === category)
              .map((topic) => (
                <TopicToggle topic={topic} />
              ))}
          </div>
        </div>
      ))
    }
  </section>

  <section id="results" class="grid sm:grid-cols-2 gap-8">
    {
      results.map(({ slug, data: { title, short, tags }, type, url }) => (
        <div
          class="responsive card text-center flex flex-col gap-4"
          data-tags={tags.join(",")}
        >
          <a href={url}>
            <span class="text-xs text-muted capitalize">«{type}»</span>
            <h3>{title}</h3>
            <p class="text-secondary">{short}</p>
            <Tags tags={tags} class="items-center justify-center" />
          </a>
        </div>
      ))
    }

    <div id="no-results-placeholder" class="col-span-2 text-muted hidden">
      No results found for the selected tags. Try selecting different skills or
      clear all filters.
    </div>
  </section>
</BaseLayout>

<script is:inline>
  document.addEventListener("DOMContentLoaded", () => {
    const raw = window.location.search.match(/topics=([^#&]+)/)?.[1];
    const selectedTopics = raw ? decodeURIComponent(raw).split(",") : [];

    const cards = document.querySelectorAll("#results > div[data-tags]");
    let anyVisible = false;

    if (selectedTopics.length > 0) {
      cards.forEach((el) => {
        const tags = (el.dataset.tags ?? "").split(",");
        const match = selectedTopics.some((topic) => tags.includes(topic));
        el.style.display = match ? "" : "none";
        if (match) anyVisible = true;
      });
    } else {
      // No topics selected: show all
      cards.forEach((el) => {
        el.style.display = "";
      });
      anyVisible = true;
    }

    const placeholder = document.getElementById("no-results-placeholder");
    if (placeholder) {
      placeholder.classList.toggle("hidden", anyVisible);
    }
  });
</script>
