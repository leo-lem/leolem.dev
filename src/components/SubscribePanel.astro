---
import { Icon } from "astro-icon/components";

interface Props {
  class?: string;
}

const { class: className = "" } = Astro.props;
---

<section class={`${className} card flex flex-col`}>
  <h2 class="text-sm font-semibold mb-2">Subscribe</h2>

  <div class="flex gap-2">
    <button id="email-btn" class="subscribe" type="button">
      <Icon name="lucide:mail" class="icon" />
      <span>Email</span>
    </button>

    <button id="push-btn" class="subscribe" type="button">
      <Icon name="lucide:bell" class="icon" />
      <span>Push</span>
    </button>

    <a
      href="/rss.xml"
      target="_blank"
      rel="noopener noreferrer"
      class="subscribe"
    >
      <Icon name="lucide:rss" class="icon" />
      <span>RSS</span>
    </a>
  </div>
</section>

<script is:inline type="module">
  const status = document.getElementById("subscribe-status");
  const pushBtn = document.getElementById("push-btn");
  const emailBtn = document.getElementById("email-btn");

  const disable = (el) => el && (el.disabled = true);
  const enable = (el) => el && (el.disabled = false);
  const setStatus = (m) => status && (status.textContent = m || "");

  const hostOk =
    location.hostname === "leolem.dev" ||
    location.hostname === "www.leolem.dev";

  const withOS = (fn) =>
    new Promise((resolve, reject) => {
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      window.OneSignalDeferred.push(async (os) => {
        try {
          resolve(await fn(os));
        } catch (e) {
          reject(e);
        }
      });
    });

  (async () => {
    disable(pushBtn);
    disable(emailBtn);
    if (!hostOk) return;

    try {
      enable(emailBtn);

      const pushOk = await withOS((os) => os.Notifications.isPushSupported());
      if (pushOk) enable(pushBtn);
    } catch (e) {
      console.error("OneSignal unavailable", e);
      disable(pushBtn);
      disable(emailBtn);
      return;
    }

    pushBtn?.addEventListener("click", async () => {
      try {
        await withOS((os) => os.Notifications.requestPermission());
        setStatus("Push enabled.");
      } catch (e) {
        console.error("Push failed", e);
        setStatus("Push not enabled.");
      }
    });

    emailBtn?.addEventListener("click", async () => {
      const v = (prompt("Email for updates:") || "").trim();
      if (!v) return;
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v)) return alert("Invalid email.");

      try {
        await withOS((os) => os.User.addEmail(v));
        setStatus("Email subscribed.");
      } catch (e) {
        console.error("Email failed", e);
        setStatus("Email failed.");
      }
    });
  })();
</script>
