---
import { Icon } from "astro-icon/components";

interface Props {
  class?: string;
}

const { class: className = "" } = Astro.props;
---

<section class={`${className} flex flex-col gap-3`}>
  <div class="flex gap-2 flex-wrap">
    <a
      href="/rss.xml"
      target="_blank"
      rel="noopener noreferrer"
      class="responsive card px-3 py-2 flex items-center gap-2"
      title="RSS"
    >
      <Icon name="lucide:rss" class="h-4 w-4" />
      <span class="hidden sm:inline text-xs">RSS</span>
    </a>

    <button
      id="push-btn"
      class="responsive card px-3 py-2 flex items-center gap-2"
    >
      <Icon name="lucide:bell" class="h-4 w-4" />
      <span class="hidden sm:inline text-xs">Push</span>
    </button>

    <button
      id="email-btn"
      class="responsive card px-3 py-2 flex items-center gap-2"
    >
      <Icon name="lucide:mail" class="h-4 w-4" />
      <span class="hidden sm:inline text-xs">Email</span>
    </button>
  </div>
</section>

<script is:inline>
  (() => {
    const $ = (id) => document.getElementById(id);
    const pushBtn = $("push-btn");
    const emailBtn = $("email-btn");

    const disable = (el) => {
      if (!el) return;
      el.disabled = true;
      el.classList.add("opacity-50", "cursor-not-allowed");
    };

    // Only allow prod
    const allowed = new Set(["leolem.dev", "www.leolem.dev"]);
    if (!allowed.has(location.hostname)) {
      console.error("[OneSignal] disabled on", location.hostname);
      disable(pushBtn);
      disable(emailBtn);
      return;
    }

    window.OneSignalDeferred = window.OneSignalDeferred || [];

    OneSignalDeferred.push(async (OneSignal) => {
      try {
        if (pushBtn) {
          pushBtn.onclick = async () => {
            try {
              await OneSignal.Notifications.requestPermission();
              console.log("Push enabled");
            } catch (e) {
              console.error("Push failed", e);
            }
          };
        }

        if (emailBtn) {
          emailBtn.onclick = async () => {
            const email = prompt("Enter your email:");
            if (!email) return;

            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
              alert("Invalid email");
              return;
            }

            try {
              await OneSignal.User.addEmail(email.trim());
              console.log("Email subscribed");
            } catch (e) {
              console.error("Email failed", e);
            }
          };
        }
      } catch (e) {
        console.error("OneSignal init failed", e);
        disable(pushBtn);
        disable(emailBtn);
      }
    });
  })();
</script>
