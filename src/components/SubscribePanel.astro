---
import { Icon } from "astro-icon/components";

interface Props {
  label?: string;
  class?: string;
}

const { label, class: classes = "" } = Astro.props;
---

<section id="subscribe" class={`card-elevated ${classes} `}>
  {label && <p class="title-sm">{label}</p>}

  <div class="cluster">
    <button id="email-btn" class="btn" type="button">
      <Icon name="lucide:mail" class="h-4 w-4" />
      <span>Email</span>
    </button>

    <button id="push-btn" class="btn" type="button">
      <Icon name="lucide:bell" class="h-4 w-4" />
      <span>Push</span>
    </button>

    <a href="/rss.xml" target="_blank" rel="noopener noreferrer" class="btn">
      <Icon name="lucide:rss" class="h-4 w-4" />
      <span>RSS</span>
    </a>
  </div>
</section>

<script is:inline type="module">
  async function alertSubscribe(kind) {
    try {
      await fetch("https://alert.leolem.dev/subscribe", {
        method: "POST",
        headers: {
          "content-type": "application/json",
          "x-webhook-secret":
            "ZXPLyTrVPeT0Y6RbKpG547VsHr+7UDrbKnTLzuSeHOIm/OdwoRWRdSzey/aC0aCD"
        },
        body: JSON.stringify({
          kind,
          page: location.href,
          email: null
        })
      });
    } catch (e) {
      console.error("Subscribe alert failed", e);
    }
  }

  window.OneSignalDeferred?.push((OneSignal) => {
    OneSignal.User.PushSubscription.addEventListener("change", (event) => {
      const wasIn = Boolean(event.previous?.optedIn);
      const isIn = Boolean(event.current?.optedIn);
      if (!wasIn && isIn) alertSubscribe("push");
    });

    OneSignal.User.EmailSubscription?.addEventListener?.("change", (event) => {
      const wasIn = Boolean(event.previous?.optedIn);
      const isIn = Boolean(event.current?.optedIn);
      if (!wasIn && isIn) {
        const email = event.current?.email ?? null;
        alertSubscribe("email", email);
      }
    });
  });

  document.getElementById("push-btn")?.addEventListener("click", () => {
    if (/iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream) {
      alert(
        "Push on iPhone does not work currently.\nPlease use another device, Email or RSS instead.\nSorry for the inconvenience!"
      );
      return;
    }

    window.OneSignalDeferred?.push((OneSignal) => {
      if (OneSignal.Notifications.permission) {
        alert("You are already subscribed to push notifications!");
        return;
      }

      OneSignal.Slidedown.promptPush({ force: true });
    });
  });

  document.getElementById("email-btn")?.addEventListener("click", async () => {
    try {
      window.OneSignalDeferred?.push((OneSignal) =>
        OneSignal.Slidedown.promptEmail({ force: true })
      );
    } catch (e) {
      console.error("Email failed", e);
    }
  });
</script>
