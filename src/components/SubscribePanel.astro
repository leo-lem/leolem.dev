---
const { label, class: classes = "" } = Astro.props as {
  label?: string;
  class?: string;
};
---

<section id="subscribe" class={`card-elevated ${classes}`}>
  <div class="flex items-center justify-between gap-4">
    <p class="title-sm">{label ?? ""}</p>

    <div class="cluster-sm">
      <button id="push-btn" class="link-muted text-xs" type="button"
        >Push</button
      >
      <span class="caption">·</span>
      <a
        href="/rss.xml"
        target="_blank"
        rel="noopener noreferrer"
        class="link-muted text-xs"
      >
        RSS
      </a>
    </div>
  </div>

  <div class="stack-sm">
    <div class="cluster">
      <div class="flex-1 min-w-[220px]">
        <input
          id="email"
          class="input"
          type="email"
          inputmode="email"
          autocomplete="email"
          placeholder="your@email.here"
          aria-label="Email address"
        />
      </div>

      <button
        id="email-btn"
        class="btn px-3 text-sm"
        type="button"
        aria-label="Subscribe"
        title="Subscribe"
        disabled="true"
        >→
      </button>
    </div>

    <div id="subscribe-status" class="text-xs hidden"></div>
  </div>
</section>

<script is:inline type="module">
  const input = document.getElementById("email");
  const emailbtn = document.getElementById("email-btn");
  const pushbtn = document.getElementById("push-btn");
  const status = document.getElementById("subscribe-status");

  function email() {
    return (input?.value || "").trim();
  }

  function isValidEmail(value) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
  }

  function statusMessage(message, isError = false) {
    if (!status) return;
    if (message == null || message === "")
      return status?.classList.add("hidden");
    status.textContent = message;
    status.classList.toggle("text-error", isError);
    status.classList.remove("hidden");
  }

  async function alertSubscribe(kind, email = null) {
    try {
      await fetch("https://alert.leolem.dev/subscribe", {
        method: "POST",
        headers: {
          "content-type": "application/json",
          "x-webhook-secret":
            "ZXPLyTrVPeT0Y6RbKpG547VsHr+7UDrbKnTLzuSeHOIm/OdwoRWRdSzey/aC0aCD"
        },
        body: JSON.stringify({
          kind,
          page: location.href,
          email
        })
      });
    } catch (e) {
      console.error("Subscribe alert failed", e);
    }
  }

  function runOneSignal(fn) {
    const d = window.OneSignalDeferred;
    if (!d || typeof d.push !== "function") {
      console.error("OneSignalDeferred not ready");
      statusMessage("Subscribe is not ready yet. Reload once.", true);
      return;
    }
    return d.push(fn);
  }

  input?.addEventListener("input", () => {
    const ok = isValidEmail(email());
    emailbtn.disabled = !ok;
    if (ok) statusMessage("");
  });

  emailbtn?.addEventListener("click", () => {
    runOneSignal(async function (OneSignal) {
      try {
        const e = email();

        if (!isValidEmail(e))
          return statusMessage("Please enter a valid email address.", true);

        OneSignal.User.addEmail(e);

        input.value = "";
        await alertSubscribe("email", e);
        statusMessage("Nice. If it went through, you're all set for updates.");
      } catch (e) {
        console.error("OneSignal addEmail failed", e);
        statusMessage("Could not subscribe right now.", true);
      }
    });
  });

  pushbtn?.addEventListener("click", () => {
    if (/iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream)
      return statusMessage("Push on iOS is not supported.", true);

    runOneSignal(function (OneSignal) {
      try {
        if (
          OneSignal.Notifications.permission &&
          OneSignal.User.PushSubscription.optedIn
        )
          return statusMessage("You are already subscribed!");

        OneSignal.User.PushSubscription.addEventListener(
          "change",
          async ({ current: { optedIn } }) => {
            if (optedIn) {
              await alertSubscribe("push");
              statusMessage("Subscribed successfully!");
            } else {
              console.error("Subscription failed or was dismissed.", true);
            }
          },
          { once: true }
        );

        OneSignal.User.PushSubscription.optIn();

        statusMessage("Requesting permission...");
      } catch (e) {
        console.error("OneSignal push subscription failed", e);
        statusMessage("Could not subscribe right now.", true);
      }
    });
  });
</script>
