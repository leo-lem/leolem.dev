---
import { Icon } from "astro-icon/components";

interface Props {
  class?: string;
}

const { class: className = "" } = Astro.props;
---

<section class={`${className} card flex flex-col`}>
  <h2 class="text-sm font-semibold mb-2">Subscribe</h2>

  <div class="flex gap-2">
    <button id="email-btn" class="subscribe" type="button">
      <Icon name="lucide:mail" class="h-4 w-4" />
      <span>Email</span>
    </button>

    <button id="push-btn" class="subscribe" type="button">
      <Icon name="lucide:bell" class="h-4 w-4" />
      <span>Push</span>
    </button>

    <a
      href="/rss.xml"
      target="_blank"
      rel="noopener noreferrer"
      class="subscribe"
    >
      <Icon name="lucide:rss" class="h-4 w-4" />
      <span>RSS</span>
    </a>
  </div>
</section>

<script is:inline type="module">
  const status = document.getElementById("subscribe-status");

  document.getElementById("push-btn")?.addEventListener("click", () => {
    if (/iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream) {
      alert(
        "Push on iPhone does not work currently.\nPlease use another device, Email or RSS instead.\nSorry for the inconvenience!"
      );
      return;
    }

    window.OneSignalDeferred?.push((OneSignal) => {
      if (OneSignal.Notifications.permission) {
        alert("You are already subscribed to push notifications!");
        return;
      }

      OneSignal.Slidedown.promptPush({ force: true });
    });
  });

  document.getElementById("email-btn")?.addEventListener("click", async () => {
    try {
      window.OneSignalDeferred?.push((OneSignal) =>
        OneSignal.Slidedown.promptEmail({ force: true })
      );
    } catch (e) {
      console.error("Email failed", e);
    }
  });
</script>
