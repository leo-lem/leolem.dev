---
import { Icon } from "astro-icon/components";

interface Props {
  label?: string;
  class?: string;
}

const { label, class: classes = "" } = Astro.props;
---

<section id="subscribe" class={`card-elevated ${classes} `}>
  {label && <p class="title-sm">{label}</p>}

  <div class="cluster">
    <button id="email-btn" class="btn" type="button">
      <Icon name="lucide:mail" class="h-4 w-4" />
      <span>Email</span>
    </button>

    <button id="push-btn" class="btn" type="button">
      <Icon name="lucide:bell" class="h-4 w-4" />
      <span>Push</span>
    </button>

    <a href="/rss.xml" target="_blank" rel="noopener noreferrer" class="btn">
      <Icon name="lucide:rss" class="h-4 w-4" />
      <span>RSS</span>
    </a>
  </div>
</section>

<script is:inline type="module">
  async function alertSubscribe(kind) {
    try {
      let email = null;

      await new Promise((resolve) => {
        window.OneSignalDeferred?.push(async (OneSignal) => {
          try {
            email = (await OneSignal.User?.getEmail?.()) ?? null;
          } catch {}
          resolve();
        });
      });

      await fetch("https://alert.leolem.dev/subscribe", {
        method: "POST",
        headers: {
          "content-type": "application/json",
          "x-webhook-secret": "YOUR_WEBHOOK_SECRET"
        },
        body: JSON.stringify({
          kind,
          page: location.href,
          email
        })
      });
    } catch (e) {
      console.error("Subscribe alert failed", e);
    }
  }

  document.getElementById("push-btn")?.addEventListener("click", () => {
    if (/iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream) {
      alert(
        "Push on iPhone does not work currently.\nPlease use another device, Email or RSS instead.\nSorry for the inconvenience!"
      );
      return;
    }

    window.OneSignalDeferred?.push((OneSignal) => {
      if (OneSignal.Notifications.permission) {
        alert("You are already subscribed to push notifications!");
        return;
      }

      OneSignal.Slidedown.promptPush({ force: true });

      setTimeout(() => alertSubscribe("push"), 1500);
    });
  });

  document.getElementById("email-btn")?.addEventListener("click", async () => {
    try {
      window.OneSignalDeferred?.push((OneSignal) => {
        OneSignal.Slidedown.promptEmail({ force: true });

        setTimeout(() => alertSubscribe("email"), 1500);
      });
    } catch (e) {
      console.error("Email failed", e);
    }
  });
</script>
