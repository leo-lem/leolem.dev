---
import { Icon } from "astro-icon/components";

interface Props {
  class?: string;
}

const { class: className = "" } = Astro.props;
---

<section class={`${className} card flex flex-col`}>
  <h2 class="text-sm font-semibold mb-2">Subscribe</h2>

  <div class="flex gap-2">
    <button id="email-btn" class="subscribe" type="button">
      <Icon name="lucide:mail" class="icon" />
      <span>Email</span>
    </button>

    <button id="push-btn" class="subscribe" type="button">
      <Icon name="lucide:bell" class="icon" />
      <span>Push</span>
    </button>

    <a
      href="/rss.xml"
      target="_blank"
      rel="noopener noreferrer"
      class="subscribe"
    >
      <Icon name="lucide:rss" class="icon" />
      <span>RSS</span>
    </a>
  </div>

  <div id="subscribe-status" class="mt-2 text-sm text-gray-600"></div>
</section>

<script is:inline type="module">
  const status = document.getElementById("subscribe-status");

  const hostOk =
    location.hostname === "leolem.dev" ||
    location.hostname === "www.leolem.dev";

  document.getElementById("push-btn")?.addEventListener("click", async () => {
    if (!hostOk) {
      console.error("Push not available on this host:", location.origin);
      status.textContent = "Push not available here.";
      return;
    }

    try {
      const os = window.OneSignal;
      if (!os?.Notifications?.requestPermission) {
        console.error("OneSignal not ready or Notifications API missing:", os);
        status.textContent = "Push unavailable right now.";
        return;
      }

      await os.Notifications.requestPermission();
      status.textContent = "Push enabled.";
    } catch (e) {
      console.error("Push failed", e);
      status.textContent = "Push not enabled.";
    }
  });

  document.getElementById("email-btn")?.addEventListener("click", async () => {
    if (!hostOk) {
      console.error("Email not available on this host:", location.origin);
      status.textContent = "Email not available here.";
      return;
    }

    let v = "";
    while (true) {
      v = (prompt("Email for updates:", v) || "").trim();
      if (!v) return;

      if (/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v)) break;

      alert("Invalid email. Please try again.");
    }

    try {
      const os = window.OneSignal;
      if (!os?.User?.addEmail) {
        console.error("OneSignal not ready or User API missing:", os);
        status.textContent = "Email unavailable right now.";
        return;
      }

      os.User.addEmail(v);
      status.textContent = "Email submitted.";
    } catch (e) {
      console.error("Email failed", e);
      status.textContent = "Email failed.";
    }
  });
</script>
