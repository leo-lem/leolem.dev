---
import type { CollectionEntry } from "astro:content";
import DynamicImage from "./DynamicImage.astro";

interface Props {
  topic: CollectionEntry<"topics">;
}
const {
  topic: {
    id,
    data: { icon, confidence, isPriority }
  }
} = Astro.props;
---

<div
  class={`w-16 sm:w-20 aspect-square responsive topic card flex flex-col items-center justify-center gap-1`}
  data-topic-id={id}
>
  <div class="flex flex-row gap-1">
    {
      icon && (
        <DynamicImage
          src={`icons/${icon}.svg`}
          alt={id}
          class="w-4 sm:w-6 aspect-square dark:invert"
        />
      )
    }

    {
      confidence && (
        <div class="flex flex-col-reverse h-6 w-1 rounded-full overflow-hidden bg-[var(--text-card-color)]">
          <div class="bg-intense" style={`height: ${confidence}%`} />
        </div>
      )
    }
  </div>

  <span
    class="text-xs font-semibold text-nowrap text-ellipsis overflow-hidden max-w-24"
  >
    {id}
  </span>
</div>

<script is:inline>
  document.addEventListener("DOMContentLoaded", () => {
    const params = new URLSearchParams(window.location.search);
    const selectedTopics = params.get("topics")?.split(",") ?? [];

    document.querySelectorAll("[data-topic-id]").forEach((el) => {
      const id = el.dataset.topicId;
      if (selectedTopics.includes(id)) {
        el.classList.add("selected");
      }

      el.addEventListener("click", () => {
        const current = new Set(selectedTopics);
        if (current.has(id)) {
          current.delete(id);
        } else {
          current.add(id);
        }

        const updated = [...current].join(",");
        const base = window.location.origin + window.location.pathname;
        const query = updated.length > 0 ? `?topics=${updated}` : "";
        window.location.href = `${base}${query}#results`;
      });
    });
  });
</script>

<style>
  .topic {
    transition: all 0.2s ease;
  }

  .topic:hover {
    transform: translateY(-2px);
  }

  .topic.selected {
    @apply ring-2 ring-blue-500 bg-blue-50 dark:bg-blue-900/20;
  }
</style>
