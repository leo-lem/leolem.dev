---
import type { CollectionEntry } from "astro:content";
import { Icon } from "astro-icon/components";

interface Props {
  topic: CollectionEntry<"topics">;
  class?: string;
}
const {
  topic: {
    id,
    data: { icon, confidence }
  },
  class: classes = ""
} = Astro.props as Props;
---

<div class=`topic stack-sm overflow-ellipsis ${classes}` data-topic-id={id}>
  <div class="flex flex-row gap-1 items-center justify-center">
    {icon && <Icon name={icon} class="icon-sm" />}

    {
      confidence && (
        <div class="flex flex-col-reverse h-10 w-1 rounded-full overflow-hidden bg-[var(--text-card-color)]">
          <div class="accent" style={`height: ${confidence}%`} />
        </div>
      )
    }
  </div>

  <span class="text-xs font-semibold p-1 capitalize">
    {id}
  </span>
</div>

<script is:inline>
  document.addEventListener("DOMContentLoaded", () => {
    const params = new URLSearchParams(window.location.search);
    const selectedTopics = params.get("topics")?.split(",") ?? [];

    document.querySelectorAll("[data-topic-id]").forEach((el) => {
      const id = el.dataset.topicId;
      if (selectedTopics.includes(id)) {
        el.classList.add("selected");
      }

      el.addEventListener("click", () => {
        const current = new Set(selectedTopics);
        if (current.has(id)) {
          current.delete(id);
        } else {
          current.add(id);
        }

        const updated = [...current].join(",");
        const base = window.location.origin + window.location.pathname;
        const query = updated.length > 0 ? `?topics=${updated}` : "";
        window.location.href = `${base}${query}#results`;
      });
    });
  });
</script>

<style>
  .topic {
    transition: all 0.2s ease;
  }

  .topic:hover {
    transform: translateY(-2px);
  }

  .topic.selected {
    @apply ring-2 ring-blue-500 bg-blue-50 dark:bg-blue-900/20;
  }
</style>
