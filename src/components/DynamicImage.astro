---
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";

const images = import.meta.glob<{ default: ImageMetadata }>("/src/assets/**/*");

interface Props {
  id?: string;
  src: string; // WITHOUT extension
  alt: string | null;
  class?: string;
  loading?: "lazy" | "eager";
  onclick?: string;
}

const {
  id,
  src,
  alt,
  class: classes,
  loading = "eager",
  onclick
} = Astro.props;

const dir = src.includes("/") ? src.slice(0, src.lastIndexOf("/") + 1) : "";
const name = src.split("/").pop();

const primary = Object.entries(images).find(([p]) =>
  p.startsWith(`/src/assets/${dir}${name}.`)
)?.[1];

const fallback = Object.entries(images).find(([p]) =>
  p.startsWith(`/src/assets/${dir}default.`)
)?.[1];

const image = primary ?? fallback;

if (!image) throw new Error(`Image not found: ${src}`);
---

<Image
  id={id}
  src={image()}
  alt={alt}
  class={classes}
  loading={loading}
  onclick={onclick}
/>
