name: Deploy Site
on:
  workflow_dispatch:
  schedule:
    - cron: "0 18 * * 0"
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
env:
  BASE_URL: https://leolem.dev

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/bootstrap
      - uses: ./.github/actions/checkout-content
        env:
          CONTENT_REPO_TOKEN: ${{ secrets.CONTENT_REPO_TOKEN }}
      - run: npm run sync
      - name: Build site
        run: npm run build
        env:
          NODE_ENV: production
          FAVORITE_ALBUM: ${{ vars.FAVORITE_ALBUM }}
      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v4
        with:
          path: dist
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  smoke:
    needs: deploy
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      checks: write
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/bootstrap
      - run: npx playwright install
      - uses: actions/cache@v5
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('package-lock.json') }}
          restore-keys: ${{ runner.os }}-playwright-
      - name: Run smoke tests
        run: npm run smoke

  co2:
    needs: deploy
    runs-on: ubuntu-latest
    permissions:
      contents: read
    environment:
      name: co2
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/bootstrap
      - uses: actions/cache@v5
        with:
          path: baseline.co2
          key: baseline-co2-${{ github.sha }}
          restore-keys: baseline-co2-
      - name: Detect COâ‚‚ regression
        run: npm run co2
        env:
          CO2_BASELINE: ${{ vars.CO2_BASELINE }}

  notify:
    needs: [smoke, co2]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/bootstrap
      - uses: ./.github/actions/checkout-content
        env:
          CONTENT_REPO_TOKEN: ${{ secrets.CONTENT_REPO_TOKEN }}
      - name: Send OneSignal notifications
        run: node .notify.mjs
        env:
          ONESIGNAL_APP_ID: ${{ secrets.ONESIGNAL_APP_ID }}
          ONESIGNAL_REST_API_KEY: ${{ secrets.ONESIGNAL_REST_API_KEY }}
          ONESIGNAL_TEMPLATE_ID: ${{ secrets.ONESIGNAL_TEMPLATE_ID }}
      - name: Commit notification state
        env:
          CONTENT_REPO_TOKEN: ${{ secrets.CONTENT_REPO_TOKEN }}
        run: |
          cd .content
          if git diff --quiet; then exit 0; fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git remote set-url origin https://x-access-token:${CONTENT_REPO_TOKEN}@github.com/leo-lem/content.leolem.dev.git

          git add .notified.json
          git commit -m "chore: mark blog notifications sent"
          git push
